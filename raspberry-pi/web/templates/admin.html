<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TidalAI Control Center</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-primary: #8b5cf6;
            --accent-danger: #ef4444;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #a78bfa, #2dd4bf);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid #334155;
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #334155;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--accent-danger);
            color: #fca5a5;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
            font-family: 'Fira Code', monospace;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(var(--color) var(--percent), #334155 0);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .progress-circle::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--bg-card);
            border-radius: 50%;
        }

        .progress-value {
            position: absolute;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .log-console {
            background: #000;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #4ade80;
            margin-bottom: 20px;
        }

        .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #111;
            padding-bottom: 2px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-ok {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .status-warn {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .status-crit {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .monitor-active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>‚öôÔ∏è TidalAI Control Center</h1>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">
                    System Status & Logs
                </div>
            </div>
            <div>
                <a href="/" class="btn">üè† Volver a Studio</a>
                <button onclick="restartServer()" class="btn btn-danger" style="margin-left: 10px;">üîÑ Reiniciar
                    Servicio</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="card">
                <div class="progress-circle" id="cpu-circle" style="--color: #a78bfa; --percent: 0%;">
                    <span class="progress-value" id="cpu-val">0%</span>
                </div>
                <div class="stat-label">CPU Load</div>
            </div>

            <div class="card">
                <div class="progress-circle" id="ram-circle" style="--color: #2dd4bf; --percent: 0%;">
                    <span class="progress-value" id="ram-val">0%</span>
                </div>
                <div class="stat-label">RAM Usage</div>
                <div id="ram-detail" style="font-size: 0.8rem; color: #666; margin-top: 5px;">- / - MB</div>
            </div>

            <div class="card">
                <div class="stat-value" id="temp-val" style="color: #fcd34d;">--¬∞C</div>
                <div class="stat-label">Temperatura</div>
            </div>

            <div class="card">
                <div class="stat-value" id="disk-val" style="font-size: 1.8rem;">--</div>
                <div class="stat-label">Disco (Root)</div>
                <div class="stat-label" id="uptime-val" style="margin-top: 10px; font-size: 0.7rem; color: #666;">
                    Uptime: --</div>
                <div class="stat-label" id="uptime-val" style="margin-top: 10px; font-size: 0.7rem; color: #666;">
                    Uptime: --</div>
            </div>
        </div>

        <!-- SECCI√ìN DESCARGAS (PORTABLE KIT) -->
        <div class="card" style="margin-bottom: 30px; text-align: left; border-color: #f59e0b;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 1.3rem; color: #f59e0b;">üì¶ Portable Client Kit</h2>
                    <p style="color: #94a3b8; margin: 5px 0 0 0; font-size: 0.9rem;">
                        Descarga todo lo necesario para conectar un nuevo PC/Mac a este cerebro.
                        Incluye instaladores autom√°ticos (Runtime / Studio) y scripts de SuperCollider.
                    </p>
                </div>
                <a href="/api/admin/download-kit" class="btn"
                    style="background: linear-gradient(135deg, #f59e0b, #d97706); color: black; font-weight: bold; text-decoration: none;">
                    ‚¨áÔ∏è Descargar Instalador Universal (.zip)
                </a>
            </div>
        </div>

        <!-- SECCI√ìN APRENDIZAJE AUT√ìNOMO -->
        <div class="card" style="margin-bottom: 30px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <h2 style="margin: 0; font-size: 1.3rem; color: #a78bfa;">üß¨ Aprendizaje Aut√≥nomo</h2>
                    <p style="color: #94a3b8; margin: 5px 0 0 0; font-size: 0.9rem;">
                        Ejecuta rondas de evoluci√≥n gen√©tica para descubrir nuevos patrones autom√°ticamente.
                    </p>
                </div>
                <div style="display:flex; gap: 10px;">
                    <button class="btn" onclick="toggleConfig()" id="btn-config-toggle">‚öôÔ∏è Configurar</button>
                    <button id="btn-train" onclick="runAutoTraining()" class="btn"
                        style="background: linear-gradient(135deg, #8b5cf6, #ec4899); border: none; font-weight: bold;">
                        üöÄ Ejecutar Ronda Nocturna
                    </button>
                    <button id="btn-scavenge" onclick="runScavenge()" class="btn"
                        style="background: linear-gradient(135deg, #2dd4bf, #0891b2); border: none; font-weight: bold;">
                        üï∑Ô∏è Recolectar
                    </button>
                </div>
            </div>

            <!-- Panel de Configuraci√≥n de Pesos -->
            <div id="config-panel"
                style="display:none; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 20px;">
                <h3 style="font-size: 1rem; margin-top: 0; color: #e2e8f0;">Ajustes de "Gusto" Art√≠stico (Pesos)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="slider-group">
                        <label style="display:flex; justify-content:space-between;">Densidad <span
                                id="v-density">1.0</span></label>
                        <input type="range" id="w-density" min="0" max="2" step="0.1" value="1" style="width:100%"
                            oninput="updateVal('density')">
                    </div>
                    <div class="slider-group">
                        <label style="display:flex; justify-content:space-between;">Variedad <span
                                id="v-variety">1.0</span></label>
                        <input type="range" id="w-variety" min="0" max="2" step="0.1" value="1" style="width:100%"
                            oninput="updateVal('variety')">
                    </div>
                    <div class="slider-group">
                        <label style="display:flex; justify-content:space-between;">Complejidad <span
                                id="v-complexity">1.0</span></label>
                        <input type="range" id="w-complexity" min="0" max="2" step="0.1" value="1" style="width:100%"
                            oninput="updateVal('complexity')">
                    </div>
                    <div class="slider-group">
                        <label style="display:flex; justify-content:space-between;">Groove (Eucl) <span
                                id="v-euclidean">1.0</span></label>
                        <input type="range" id="w-euclidean" min="0" max="2" step="0.1" value="1" style="width:100%"
                            oninput="updateVal('euclidean')">
                    </div>
                </div>

                <h3 style="font-size: 1rem; color: #e2e8f0;">Par√°metros de Entrenamiento</h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div>
                        <label style="font-size: 0.8rem; color: #94a3b8;">Temp (0.1 - 2.0)</label>
                        <input type="number" id="p-temp" value="1.2" step="0.1"
                            style="width:100%; background:#0f172a; border:1px solid #334155; color:white; padding:5px; border-radius:4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: #94a3b8;">Batch Size</label>
                        <input type="number" id="p-batch" value="50"
                            style="width:100%; background:#0f172a; border:1px solid #334155; color:white; padding:5px; border-radius:4px;">
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: #94a3b8;">Exigencia (-50, 50)</label>
                        <input type="number" id="p-strict" value="0"
                            style="width:100%; background:#0f172a; border:1px solid #334155; color:white; padding:5px; border-radius:4px;">
                    </div>
                    <div style="display:flex; align-items:flex-end;">
                        <button class="btn" onclick="saveEvolutionConfig()"
                            style="width:100%; background: var(--accent-success); color:black; font-weight:bold;">Guardar
                            Cambios</button>
                    </div>
                </div>
            </div>

            <div id="training-status"
                style="margin-top: 15px; display: none; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="train-spinner">‚è≥</span>
                    <span id="train-msg">Generando candidatos...</span>
                </div>
                <div style="width: 100%; height: 4px; background: #334155; margin-top: 10px; border-radius: 2px;">
                    <div id="train-progress"
                        style="width: 0%; height: 100%; background: #2dd4bf; transition: width 0.3s;"></div>
                </div>
            </div>

            <!-- Result List Container -->
            <div id="evolution-results"
                style="display:none; margin-top: 20px; border-top: 1px solid #334155; padding-top: 15px;">
                <h3 id="result-title" style="font-size: 1rem; color: #e2e8f0; margin-bottom: 10px;">üèÜ Resultados
                </h3>
                <div id="survivors-list"
                    style="max-height: 200px; overflow-y: auto; font-family: 'Fira Code', monospace; font-size: 0.85rem; color: #94a3b8;">
                    <!-- Items go here -->
                </div>
            </div>
        </div>

        <!-- SECCI√ìN VISUALIZACI√ìN DEL CEREBRO -->
        <div class="card" style="margin-bottom: 30px; text-align: left; padding: 0; overflow: hidden;">
            <div
                style="padding: 20px; border-bottom: 1px solid #334155; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin: 0; font-size: 1.3rem; color: #2dd4bf;">üï∏Ô∏è Mapa Mental (Grafo de Neuronas)</h2>
                    <p style="color: #94a3b8; margin: 5px 0 0 0; font-size: 0.9rem;">Visualizaci√≥n en tiempo real de las
                        conexiones probabil√≠sticas de la IA.</p>
                </div>
                <button class="btn" onclick="renderBrainGraph()">üîÑ Refrescar Mapa</button>
            </div>
            <div id="brain-viz" style="width: 100%; height: 500px; background: #0b0f1a; position: relative;">
                <div id="graph-loader"
                    style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--text-muted);">
                    Haz clic en "Refrescar" para ver la red...
                </div>
                <svg id="brain-svg" style="width: 100%; height: 100%;"></svg>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 style="margin: 0; font-size: 1.2rem;">üìú System Logs</h2>
            <div class="status-badge status-ok" id="conn-status">‚óè Live</div>
        </div>

        <div class="log-console" id="log-console">
            <div class="log-entry">Conectando al sistema...</div>
        </div>
    </div>

    <script type="module">
        import * as api from '/static/js/modules/network.js';

        const UPDATE_INTERVAL = 2000;

        async function updateStats() {
            try {
                const data = await api.getSystemStatsAPI();
                if (data.success) {
                    const s = data.stats;

                    // CPU
                    updateCircle('cpu', s.cpu);

                    // RAM
                    updateCircle('ram', s.ram_percent);
                    document.getElementById('ram-detail').textContent = `${s.ram_used} / ${s.ram_total} MB`;

                    // Temp
                    const tempElem = document.getElementById('temp-val');
                    tempElem.textContent = typeof s.temp === 'number' ? s.temp + '¬∞C' : s.temp;
                    if (typeof s.temp === 'number' && s.temp > 70) tempElem.style.color = '#ef4444';
                    else tempElem.style.color = '#fcd34d';

                    // Disk
                    document.getElementById('disk-val').textContent = s.disk + '%';
                    document.getElementById('uptime-val').textContent = 'Uptime: ' + s.uptime;

                    document.getElementById('conn-status').className = 'status-badge status-ok';
                    document.getElementById('conn-status').textContent = '‚óè Live';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('conn-status').className = 'status-badge status-crit';
                document.getElementById('conn-status').textContent = '‚óè Desconectado';
            }
        }

        async function updateLogs() {
            try {
                const data = await api.getSystemLogsAPI();
                if (data.success) {
                    const consoleElem = document.getElementById('log-console');
                    consoleElem.innerHTML = '';

                    // Invertir para mostrar lo m√°s reciente arriba (o abajo seg√∫n preferencia)
                    // Aqu√≠ mostramos en orden cronol√≥gico
                    data.logs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'log-entry';
                        div.textContent = log;
                        consoleElem.appendChild(div);
                    });

                    // Auto-scroll to bottom
                    consoleElem.scrollTop = consoleElem.scrollHeight;
                }
            } catch (err) {
                console.error(err);
            }
        }

        function updateCircle(id, percent) {
            const circle = document.getElementById(id + '-circle');
            const val = document.getElementById(id + '-val');

            circle.style.setProperty('--percent', percent + '%');
            val.textContent = percent + '%';
        }

        async function restartServer() {
            if (confirm('¬øEst√°s seguro? Esto reiniciar√° el servicio Flask en la Raspberry Pi.')) {
                try {
                    const data = await api.restartSystemAPI();
                    alert(data.message || 'Reiniciando...');
                    setTimeout(() => location.reload(), 5000);
                } catch (err) {
                    alert('Error enviando se√±al de reinicio');
                }
            }
        }

        async function runAutoTraining() {
            if (!confirm('Esto generar√° 50 patrones y seleccionar√° los mejores 10. ¬øContinuar?')) return;

            const btn = document.getElementById('btn-train');
            const statusDiv = document.getElementById('training-status');
            const msg = document.getElementById('train-msg');
            const progress = document.getElementById('train-progress');
            const resultsDiv = document.getElementById('evolution-results');
            const listDiv = document.getElementById('survivors-list');
            const title = document.getElementById('result-title');

            btn.disabled = true;
            btn.style.opacity = '0.5';
            statusDiv.style.display = 'block';
            resultsDiv.style.display = 'none'; // ocultar resultados previos
            msg.textContent = "Inicializando evoluci√≥n...";
            progress.style.width = '10%';
            title.textContent = "üèÜ Supervivientes (A√±adidos a Memoria)";

            // Simular progreso visual mientras esperamos
            let fakeProgress = 10;
            const interval = setInterval(() => {
                fakeProgress += 5;
                if (fakeProgress > 90) fakeProgress = 90;
                progress.style.width = fakeProgress + '%';

                if (fakeProgress < 30) msg.textContent = "Generando poblaci√≥n (Batch=50)...";
                else if (fakeProgress < 60) msg.textContent = "Aplicando m√©tricas de belleza...";
                else msg.textContent = "Seleccionando supervivientes...";
            }, 500);

            // Get current config values
            const config = {
                weights: {
                    density: parseFloat(document.getElementById('w-density').value),
                    variety: parseFloat(document.getElementById('w-variety').value),
                    complexity: parseFloat(document.getElementById('w-complexity').value),
                    euclidean: parseFloat(document.getElementById('w-euclidean').value)
                },
                params: {
                    temperature: parseFloat(document.getElementById('p-temp').value),
                    batch_size: parseInt(document.getElementById('p-batch').value),
                    top_k: 10, // Fixed for now
                    strictness: parseInt(document.getElementById('p-strict').value)
                },
                filters: { genre: "all", instrument: "all" } // Fixed for now
            };

            try {
                const data = await api.startEvolutionAPI(config);
                clearInterval(interval);
                progress.style.width = '100%';

                if (data.success) {
                    msg.textContent = `‚úÖ √âxito: ${data.result.survivors} nuevos patrones aprendidos.`;
                    msg.style.color = '#4ade80';

                    // Renderizar lista
                    listDiv.innerHTML = '';
                    if (data.result.patterns && data.result.patterns.length > 0) {
                        data.result.patterns.forEach(pat => {
                            const div = document.createElement('div');
                            div.style.padding = "4px 0";
                            div.style.borderBottom = "1px solid #1e293b";
                            div.textContent = pat;
                            listDiv.appendChild(div);
                        });
                        resultsDiv.style.display = 'block';
                    }
                } else {
                    msg.textContent = `‚ùå Error: ${data.error}`;
                    msg.style.color = '#ef4444';
                }
            } catch (err) {
                clearInterval(interval);
                msg.textContent = "‚ùå Error de conexi√≥n";
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        async function runScavenge() {
            if (!confirm('Esto visitar√° las webs en sources.txt y extraer√° nuevos patrones. ¬øContinuar?')) return;

            const btn = document.getElementById('btn-scavenge');
            const statusDiv = document.getElementById('training-status');
            const msg = document.getElementById('train-msg');
            const progress = document.getElementById('train-progress');
            const resultsDiv = document.getElementById('evolution-results');
            const listDiv = document.getElementById('survivors-list');
            const title = document.getElementById('result-title');

            btn.disabled = true;
            btn.style.opacity = '0.5';
            statusDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            msg.textContent = "Iniciando recolecci√≥n...";
            progress.style.width = '20%';

            try {
                const data = await api.runScavengeAPI();
                progress.style.width = '100%';
                if (data.success) {
                    msg.textContent = `üï∑Ô∏è Recolecci√≥n finalizada: ${data.result.total_added} patrones a√±adidos.`;
                    msg.style.color = '#4ade80';
                    title.textContent = "üìö Patrones Recolectados";

                    listDiv.innerHTML = '';
                    data.result.results.forEach(res => {
                        const div = document.createElement('div');
                        div.style.marginBottom = "5px";
                        div.innerHTML = `<span style="color: ${res.success ? '#2dd4bf' : '#ef4444'}">${res.success ? '‚úì' : '‚úó'}</span> ${res.url.split('/').pop()} (${res.count} patrones)`;
                        listDiv.appendChild(div);
                    });
                    resultsDiv.style.display = 'block';
                } else {
                    msg.textContent = `‚ùå Error: ${data.error}`;
                    msg.style.color = '#ef4444';
                }
            } catch (err) {
                msg.textContent = "‚ùå Error de conexi√≥n";
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
                setTimeout(() => { progress.style.width = '0%'; }, 2000);
            }
        }

        function toggleConfig() {
            const panel = document.getElementById('config-panel');
            const btn = document.getElementById('btn-config-toggle');
            if (panel.style.display === 'none') {
                loadEvolutionConfig();
                panel.style.display = 'block';
                btn.textContent = '‚ùå Cerrar Config';
            } else {
                panel.style.display = 'none';
                btn.textContent = '‚öôÔ∏è Configurar';
            }
        }

        function updateVal(id) {
            document.getElementById('v-' + id).textContent = document.getElementById('w-' + id).value;
        }

        async function loadEvolutionConfig() {
            try {
                const c = await api.getEvolutionConfigAPI();
                document.getElementById('w-density').value = c.weights.density;
                document.getElementById('w-variety').value = c.weights.variety;
                document.getElementById('w-complexity').value = c.weights.complexity;
                document.getElementById('w-euclidean').value = c.weights.euclidean;

                document.getElementById('v-density').textContent = c.weights.density;
                document.getElementById('v-variety').textContent = c.weights.variety;
                document.getElementById('v-complexity').textContent = c.weights.complexity;
                document.getElementById('v-euclidean').textContent = c.weights.euclidean;

                document.getElementById('p-temp').value = c.params.temperature;
                document.getElementById('p-batch').value = c.params.batch_size;
                document.getElementById('p-strict').value = c.params.strictness;
            } catch (e) { console.error(e); }
        }

        async function saveEvolutionConfig() {
            const config = {
                weights: {
                    density: parseFloat(document.getElementById('w-density').value),
                    variety: parseFloat(document.getElementById('w-variety').value),
                    complexity: parseFloat(document.getElementById('w-complexity').value),
                    euclidean: parseFloat(document.getElementById('w-euclidean').value)
                },
                params: {
                    temperature: parseFloat(document.getElementById('p-temp').value),
                    batch_size: parseInt(document.getElementById('p-batch').value),
                    top_k: 10,
                    strictness: parseInt(document.getElementById('p-strict').value)
                },
                filters: { genre: "all", instrument: "all" }
            };

            try {
                const data = await api.saveEvolutionConfigAPI(config);
                if (data.success) {
                    alert('‚úÖ Configuraci√≥n guardada en la Raspberry Pi');
                    toggleConfig();
                }
            } catch (e) { alert('Error guardando configuraci√≥n'); }
        }

        // --- D3.js Visualizaci√≥n del Cerebro ---
        async function renderBrainGraph() {
            const container = document.getElementById('brain-viz');
            const loader = document.getElementById('graph-loader');
            const svg = d3.select("#brain-svg");

            loader.textContent = "Analizando conexiones...";
            svg.selectAll("*").remove(); // Limpiar previo

            try {
                const data = await api.getBrainGraphAPI();
                loader.style.display = 'none';
                const width = container.clientWidth;
                const height = container.clientHeight;

                const simulation = d3.forceSimulation(data.nodes)
                    .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-150))
                    .force("center", d3.forceCenter(width / 2, height / 2));

                // Enlaces
                const link = svg.append("g")
                    .attr("stroke", "#334155")
                    .attr("stroke-opacity", 0.6)
                    .selectAll("line")
                    .data(data.links)
                    .join("line")
                    .attr("stroke-width", d => Math.sqrt(d.value));

                // Nodos
                const node = svg.append("g")
                    .selectAll("g")
                    .data(data.nodes)
                    .join("g")
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                node.append("circle")
                    .attr("r", d => 5 + Math.sqrt(d.weight))
                    .attr("fill", d => {
                        if (d.type === 'sample') return "#8b5cf6";
                        if (d.type === 'function') return "#2dd4bf";
                        if (d.type === 'number') return "#f59e0b";
                        return "#94a3b8";
                    });

                node.append("text")
                    .text(d => d.label)
                    .attr("x", 8)
                    .attr("y", 4)
                    .attr("fill", "#e2e8f0")
                    .style("font-size", "10px")
                    .style("pointer-events", "none");

                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node.attr("transform", d => `translate(${d.x},${d.y})`);
                });

                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }
            } catch (e) {
                loader.textContent = "Error cargando mapa.";
            }
        }

        // Exponer funciones necesarias al scope global (onclick de HTML)
        window.restartServer = restartServer;
        window.runAutoTraining = runAutoTraining;
        window.runScavenge = runScavenge;
        window.toggleConfig = toggleConfig;
        window.updateVal = updateVal;
        window.saveEvolutionConfig = saveEvolutionConfig;
        window.renderBrainGraph = renderBrainGraph;

        // Loop
        setInterval(() => {
            updateStats();
            updateLogs();
        }, UPDATE_INTERVAL);

        // Init
        updateStats();
        updateLogs();
    </script>
</body>

</html>